{{#section 'css'}}
    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/css/startmin.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    {{/section}}

<div id="wrapper">

    <div id="page-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="page-header">PRODUCT</h1>
                </div>
                <!-- /.col-lg-12 -->
            </div>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            Product Tables
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-body">

                            <div class="table-responsive" id="table-responsive">
                                <div class="row" style="margin:0; margin-bottom:10px;">
                                    <div class="col-sm-6">
                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                            data-target="#addModal">Add
                                            Product</button>
                                    </div>
                                    <div class="col-sm-6">
                                        <div style="text-align: right;">
                                            <label name="search-bar" style="font-weight: normal;">Search:
                                                <input id="search-bar"
                                                    style="display: inline-block; width: auto; margin-left: 0.5em;"
                                                    type="search" class="form-control input-sm" placeholder="">
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="margin:0">
                                    <div class="col-sm-6">
                                        <label for="itemsPerPage" style="font-weight: normal;">Show
                                            <select class="form-control input-sm" id="itemsPerPage"
                                                style="width:75px; display:inline-block;">
                                                <option>10</option>
                                                <option>25</option>
                                                <option>50</option>
                                                <option>100</option>
                                            </select> entries</label>
                                    </div>
                                    <div class="col-sm-6">
                                        <div style="text-align: right;">
                                            <label for="filter" style="font-weight: normal;">Categories
                                                <select class="form-control input-sm" id="filter"
                                                    style="width:200px; display:inline-block;">
                                                    <option>All</option>
                                                    {{#each categories}}
                                                    <option>{{name}}</option>
                                                    {{/each}}
                                                </select></label>
                                        </div>
                                    </div>
                                </div>

                                <table class="table table-striped table-bordered table-hover" id="dataTables">
                                    <thead>
                                        <tr>
                                            <th class="col-sm-1">ID</th>
                                            <th class="col-sm-2">Name</th>
                                            <th class="col-sm-0.5">Price</th>
                                            <th class="col-sm-0.5">Image</th>
                                            <th hidden>Category</th>
                                            <th class="col-sm-0.5">Availability</th>
                                            {{!-- <th>Quantity</th> --}}
                                            <th class="col-sm-7">Description</th>
                                            {{!-- <th>Specification</th> --}}
                                            <th class="col-sm-0.5">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each list_product}}
                                        <tr class={{id}}>
                                            <td class="product_id">{{id}}</td>
                                            <td class="product_name">{{name}}</td>
                                            <td class="product_price">{{price}}</td>
                                            <th class="product_image"><img style="width:100px; height:100px"
                                                    src="{{imagePath}}"></th>
                                            <td class="product_category" hidden>{{categoryId}}-{{category}}</td>
                                            <th class="product_avai">{{availability}}</th>
                                            {{!-- <td>quantity</td> --}}
                                            <td class="center product_description">{{description}}</td>
                                            {{!-- <td class="center">specification</td> --}}
                                            <td>
                                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                                    data-target="#exampleModal" data-whatever="{{id}}">Edit</button>
                                            </td>
                                        </tr>
                                        {{/each}}

                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <th class="col-sm-1">ID</th>
                                            <th class="col-sm-2">Name</th>
                                            <th class="col-sm-0.5">Price</th>
                                            <th class="col-sm-0.5">Image</th>
                                            <th hidden>Category</th>
                                            <th class="col-sm-0.5">Availability</th>
                                            {{!-- <th>Quantity</th> --}}
                                            <th class="col-sm-7">Description</th>
                                            {{!-- <th>Specification</th> --}}
                                            <th class="col-sm-0.5">Action</th>
                                        </tr>
                                    </tfoot>

                                </table>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination" style="float:right;margin-top:0;">
                                        <li class="page-item">
                                            <a class="page-link" aria-label="Previous" id="previousPage">
                                                <span aria-hidden="true">&laquo;</span>
                                                <span class="sr-only">Previous</span>
                                            </a>
                                        </li>
                                        {{#each count}}
                                        <li class="page-item"><a class="page-link" id="{{ord}}" {{#if
                                                isfirst}}style="background: beige;" {{/if}}>{{ord}}</a></li>
                                        {{/each}}
                                        <li class="page-item">
                                            <a class="page-link" aria-label="Next" id="nextPage">
                                                <span aria-hidden="true">&raquo;</span>
                                                <span class="sr-only">Next</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                        <!-- /.table-responsive -->

                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
</div>
<!-- /#page-wrapper -->

</div>
<!-- /#wrapper -->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addModalLabel">New message</h4>
            </div>
            <div class="modal-body">
                <form method="POST" action="/products/add/?page=0&limit=10" enctype="multipart/form-data">

                    <div class="form-group">
                        <label for="name" class="control-label">Name:</label>
                        <input type="text" class="form-control" name="name" id="newName" required>
                    </div>
                    <div class="form-group">
                        <label for="newCategory" style="font-weight: normal;">Categories
                            <select class="form-control input-sm" id="newCategory" name="categoryId">

                                {{#each categories}}
                                <option value="{{id}}">{{name}}</option>
                                {{/each}}
                            </select>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="newImage" class="control-label">Image:</label>
                        <input type="file" class="form-control" name="imagePath" id="newImage" required>
                    </div>

                    <div class="form-group">
                        <label for="newPrice" class="control-label">Price:</label>
                        <input type="number" class="form-control" name="price" id="newPrice" required>
                    </div>
                    <div class="form-group">
                        <label for="newAvailability" class="control-label">Availability:</label>
                        <input type="number" class="form-control" name="availability" id="newAvailability" required>
                    </div>
                    <div class="form-group">
                        <label for="description" class="control-label">Description:</label>
                        <textarea class="form-control" resize="none" name="description" id="newDescription" required
                            style="resize:vertical"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">New message</h4>
            </div>
            <div class="modal-body">
                <form method="POST" action="../products/edit/" enctype="multipart/form-data">
                    <div class="form-group" hidden>
                        <label for="id" class="control-label"></label>
                        <input type="text" class="form-control" name="id" id="id">
                    </div>
                    <div class="form-group">
                        <label for="name" class="control-label">Name:</label>
                        <input type="text" class="form-control" name="name" id="name">
                    </div>
                    <div class="form-group">
                        <label for="category" style="font-weight: normal;">Categories
                            <select class="form-control input-sm" id="category" name="categoryId">

                                {{#each categories}}
                                <option value="{{id}}">{{name}}</option>
                                {{/each}}
                            </select>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="imagePath" class="control-label">Image:</label>
                        <input type="text" class="form-control" id="imagePath" disabled>
                    </div>
                    <div class="form-group">
                        <b>New image: </b><input type="file" class="form-control" name="newImagePath" id="newImagePath">
                    </div>
                    <div class="form-group">
                        <label for="price" class="control-label">Price:</label>
                        <input type="number" class="form-control" name="price" id="price">
                    </div>
                    <div class="form-group">
                        <label for="availability" class="control-label">Availability:</label>
                        <input type="number" class="form-control" name="availability" id="availability">
                    </div>
                    <div class="form-group">
                        <label for="description" class="control-label">Description:</label>
                        <textarea class="form-control" resize="none" name="description" id="description"
                            style="resize:vertical"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" data-href="/products/delete" data-toggle="modal"
                            data-target="#confirm-delete">Delete</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                Are you sure?
            </div>
            <div class="modal-body">
                This action cannot be reversed
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button class="btn btn-danger btn-ok">Delete</button>
            </div>
        </div>
    </div>
</div>

{{#section 'js'}}

    


<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="/js/metisMenu.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/startmin.js"></script>

<!-- Page-Level Demo Scripts - Tables - Use for reference -->


<script>
    //window.addEventListener('load', onloadpage);
    $('#exampleModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button that triggered the modal
        var product_id = button.data('whatever') // Extract info from data-* attributes
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var product_name = $('.' + product_id + ' .product_name')[0].innerText;
        var product_description = $('.' + product_id + ' .product_description')[0].innerText;
        var product_price = $('.' + product_id + ' .product_price')[0].innerText;
        var product_avai = $('.' + product_id + ' .product_avai')[0].innerText;
        var product_image = $('.' + product_id + ' .product_image img')[0].src;
        var product_category = $('.' + product_id + ' .product_category')[0].innerText;
        var category = product_category.split("-");
        var modal = $(this)
        modal.find('.modal-title').text('Edit to ' + product_name)
        modal.find('.modal-body #name').val(product_name)
        modal.find('.modal-body #id').val(product_id)
        modal.find('.modal-body #description').val(product_description)
        modal.find('.modal-body #price').val(product_price)
        modal.find('.modal-body #availability').val(product_avai)
        modal.find('.modal-body #imagePath').val(product_image)
        //console.log(category[1])
        modal.find('.modal-body #categoryId').val(category[0])
    });
</script>
<script>
    $('#addModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button that triggered the modal
        // Extract info from data-* attributes
        // If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
        // Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
        var modal = $(this)
        modal.find('.modal-title').text('New Product')
        const product_name = modal.find('.modal-body #name').val()
        const product_description = modal.find('.modal-body #description').val()
    });
</script>
<script>
    $('#confirm-delete').on('show.bs.modal', function (e) {
        const id = $('#exampleModal').find('#id').val();
        //$(this).find('.btn-ok').attr('href', $(e.relatedTarget).data('href')+'/'+id);
        $(this).find('.btn-ok').click(function () {
            $.post('../products/delete/', { id }, function (result) {
                $(location).attr('href', result);
            })
        })
    });
</script>
<script>
    $('.page-item .page-link').click(function () {
        const searchKeyWords = $('#search-bar').val();
        const filterKeyWords = $('#filter').val();
        const tag_a = $(this);
        var page;
        //console.log(tag_a[0].id);
        if (tag_a[0].id=="previousPage")
        {
            const curPage = new URLSearchParams(window.location.search).get('page');
            page = Number(curPage);
            if (page==0)
                {
                return;
                }
            page = page -1;
        }
        else 
        if (tag_a[0].id=="nextPage")
        {
            const curPage = new URLSearchParams(window.location.search).get('page');
            page = Number(curPage);
            if (page >= {{count.length}}-1)
                {
                return;
                }
            page = page +1;
        }
        else 
            page = Number(tag_a[0].id) - 1;
        const limit = +$('#itemsPerPage').val();
        if (filterKeyWords == "All" && searchKeyWords == "") {

            //const offset = itemsPerPage * (pagniation - 1)
            window.location.replace('?page=' + page + '&limit=' + limit);
            //$('#' + tag_a.id).css('background', 'beige');

        }
        else
            if (filterKeyWords == "All" && searchKeyWords != "") {
                window.history.pushState("search", "Search", "/products/?page=" + page + "&limit=" + limit);
                $.post('../products/search/', {page, limit, searchKeyWords, filterKeyWords: "" }, function (res) {
                    $('#wrapper').html(res);
                    $('#search-bar').val(searchKeyWords);
                    $('#filter').val(filterKeyWords);
                });
            }
            else {
                if (filterKeyWords != "All" && searchKeyWords != "") {
                    window.history.pushState("search", "Search", "/products/?page=" + page + "&limit=" + limit);

                    $.post('../products/search/', {page, limit, searchKeyWords, filterKeyWords }, function (res) {
                        $('#wrapper').html(res);
                        $('#search-bar').val(searchKeyWords);
                        $('#filter').val(filterKeyWords);
                    });
                }
                else {
                    window.history.pushState("search", "Search", "/products/?page=" + page + "&limit=" + limit);
                    $.post('../products/search/', {page, limit, searchKeyWords: "", filterKeyWords }, function (res) {
                        $('#wrapper').html(res);
                        $('#search-bar').val(searchKeyWords);
                        $('#filter').val(filterKeyWords);
                        $('#search-bar').focus();
                    });
                }
            }
    });
</script>
<script>
    function delay(ms, callback) {
        var timer = 0;
        return function () {
            var context = this, args = arguments;
            clearTimeout(timer);
            timer = setTimeout(function () {
                callback.apply(context, args);
            }, ms || 0);
        };
    }
    $('#search-bar').on('input', delay(350, function () {
        const searchKeyWords = $('#search-bar').val();
        const limit = +$('#itemsPerPage').val();
        const filterKeyWords = $('#filter').val();
        $('#search-bar')[0].disabled = true
        if (filterKeyWords != "All") {
            $.post('../products/search', { limit, searchKeyWords, filterKeyWords }, function (res) {
                $('#wrapper').html(res)
                $('#search-bar').val(searchKeyWords);
                $('#filter').val(filterKeyWords);
                $('#itemsPerPage').val(limit);
                $('#search-bar').focus();
            });
        }
        else {
            $.post('../products/search', { limit, searchKeyWords, filterKeyWords: "" }, function (res) {
                $('#wrapper').html(res);
                $('#search-bar').val(searchKeyWords);
                $('#filter').val(filterKeyWords);
                $('#itemsPerPage').val(limit);
                $('#search-bar').focus();
            });
        }
        window.history.pushState("search", "Search", "/products/?page=0&limit=" + limit);
        
    }));
</script>
<script>
    $('#filter').on('change', function () {
        const filterKeyWords = $('#filter').val();
        const limit = +$('#itemsPerPage').val();
        if (filterKeyWords != "All") {
            $.post('../products/filter', { limit, filterKeyWords }, function (res) {
                $('#wrapper').html(res);
                //console.log(res);
                $('#filter').val(filterKeyWords);
                $('#itemsPerPage').val(limit);
                window.history.pushState("filter", "Filter", "/products/?page=0&limit=" + limit);
            });
        }
        else {
            $.post('../products/filter', { limit, filterKeyWords:"" }, function (res) {
                $('#wrapper').html(res);
                //console.log(res);
                $('#filter').val(filterKeyWords);
                $('#itemsPerPage').val(limit);
                window.history.pushState("filter", "Filter", "/products/?page=0&limit=" + limit);
            });
        }
    });

</script>
<script>
    $('#itemsPerPage').on('change', function () {
        const limit = +$('#itemsPerPage').val();
        const filterKeyWords = $('#filter').val();
        if (filterKeyWords!="All")
        {
            $.post('../products/filter', { limit, filterKeyWords }, function (res) {
                $('#wrapper').html(res);
                //console.log(res);
                $('#filter').val(filterKeyWords);
                $('#itemsPerPage').val(limit);
                window.history.pushState("filter", "Filter", "/products/?page=0&limit=" + limit);
            });
        }
        else{
        //window.location.replace('?page=0&limit=' + limit);
        $.get('../products/?page=0&limit=' + limit, function (res) {
            $('#wrapper').html(res);
            $('#itemsPerPage').val(limit);
            window.history.pushState("table", "Table", "/products/?page=0&limit=" + limit);
        });
        }
    });

</script>
{{/section}}